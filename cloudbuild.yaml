# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Cloud Build â€” Atende_Pyloto
# Pipeline CI/CD para staging e production
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

timeout: "1800s"

options:
  machineType: "E2_HIGHCPU_8"
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _SERVICE: "atende-pyloto"
  _ENV: "staging"
  _REGION: "us-central1"
  _ARTIFACT_REGISTRY: "atende"
  _MIN_INSTANCES: "1"  # Trocar para "0" no fim do dia
  _MAX_INSTANCES: "10"
  _MEMORY: "512Mi"
  _CPU: "1"
  _CONCURRENCY: "80"
  _TIMEOUT: "60s"

steps:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) Lint e verificaÃ§Ã£o de cÃ³digo (fail-fast)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: "lint-check"
    name: "python:3.12-slim"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        pip install --quiet ruff
        echo "ğŸ” Executando lint com ruff..."
        ruff check src/ tests/ --output-format=github
        echo "âœ… Lint passou"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) Testes unitÃ¡rios (fail-fast)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: "run-tests"
    name: "python:3.12-slim"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        pip install --quiet .
        pip install --quiet pytest pytest-asyncio pytest-cov
        echo "ğŸ§ª Executando testes..."
        PYTHONPATH=src pytest tests/ -v --tb=short -x
        echo "âœ… Testes passaram"
    waitFor: ["lint-check"]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) Build da imagem Docker
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: "build-image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        set -euo pipefail
        
        # Gerar tag baseada no commit SHA ou timestamp
        if [ -n "${SHORT_SHA:-}" ]; then
          TAG="${SHORT_SHA}"
        else
          TAG=$(git rev-parse --short HEAD 2>/dev/null || echo "manual-$(date +%s)")
        fi
        
        echo "ğŸ—ï¸  Building with tag: $$TAG"
        
        docker build --no-cache \
          -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:$$TAG \
          -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:latest \
          -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:${_ENV} \
          .
        
        # Exportar TAG para prÃ³ximos steps
        echo "$$TAG" > /workspace/image_tag.txt
        
        echo "âœ… Build concluÃ­do"
    timeout: "1200s"
    waitFor: ["run-tests"]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4) Push das tags para Artifact Registry
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: "push-tag"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        TAG=$(cat /workspace/image_tag.txt)
        echo "ğŸ“¦ Pushing tag: $$TAG"
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:$$TAG
        echo "âœ… Tag $$TAG publicada"
    waitFor: ["build-image"]

  - id: "push-latest"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "ğŸ“¦ Pushing latest..."
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:latest
        echo "âœ… Tag latest publicada"
    waitFor: ["build-image"]

  - id: "push-env"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "ğŸ“¦ Pushing ${_ENV}..."
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:${_ENV}
        echo "âœ… Tag ${_ENV} publicada"
    waitFor: ["build-image"]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5) Deploy no Cloud Run
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: "deploy-cloud-run"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        set -euo pipefail

        SERVICE_NAME="${_SERVICE}-${_ENV}"
        IMAGE="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE}:${_ENV}"

        # Secrets montados do Secret Manager
        SECRETS="OPENAI_API_KEY=openai-api-key-${_ENV}:latest"
        SECRETS="$$SECRETS,REDIS_URL=redis-url-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_ACCESS_TOKEN=whatsapp-access-token-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_API_VERSION=whatsapp-api-version-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_BUSINESS_ACCOUNT_ID=whatsapp-business-account-id-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_PHONE_NUMBER_ID=whatsapp-phone-number-id-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_VERIFY_TOKEN=whatsapp-verify-token-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_WEBHOOK_SECRET=whatsapp-webhook-secret-${_ENV}:latest"
        SECRETS="$$SECRETS,WHATSAPP_APP_SECRET=whatsapp-webhook-secret-${_ENV}:latest"
        SECRETS="$$SECRETS,FLOW_PRIVATE_KEY=flow-private-key-${_ENV}:latest"
        SECRETS="$$SECRETS,GOOGLE_SERVICE_ACCOUNT_JSON=google-service-account-key-${_ENV}:latest"
        SECRETS="$$SECRETS,GOOGLE_CALENDAR_ID=google-calendar-id-${_ENV}:latest"

        # VariÃ¡veis de ambiente
        ENV_VARS="ENVIRONMENT=${_ENV}"
        ENV_VARS="$$ENV_VARS,LOG_LEVEL=INFO"
        ENV_VARS="$$ENV_VARS,WHATSAPP_WEBHOOK_PROCESSING_MODE=inline"
        ENV_VARS="$$ENV_VARS,WHATSAPP_FLOW_ENDPOINT_ENABLED=true"
        ENV_VARS="$$ENV_VARS,FIRESTORE_PROJECT_ID=atende-pyloto"
        ENV_VARS="$$ENV_VARS,GCP_PROJECT=atende-pyloto"

        # Configurar CALENDAR_ENABLED (true em staging, false em production)
        if [ "${_ENV}" = "production" ]; then
          CALENDAR_ENABLED_VAL="false"
        else
          CALENDAR_ENABLED_VAL="true"
        fi
        ENV_VARS="$$ENV_VARS,CALENDAR_ENABLED=$$CALENDAR_ENABLED_VAL"

        echo "ğŸš€ Deploying $$SERVICE_NAME..."

        gcloud run deploy "$$SERVICE_NAME" \
          --image "$$IMAGE" \
          --region "${_REGION}" \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory "${_MEMORY}" \
          --cpu "${_CPU}" \
          --min-instances "${_MIN_INSTANCES}" \
          --max-instances "${_MAX_INSTANCES}" \
          --concurrency "${_CONCURRENCY}" \
          --timeout "${_TIMEOUT}" \
          --cpu-throttling \
          --set-env-vars "$$ENV_VARS" \
          --set-secrets "$$SECRETS"

        echo "âœ… Deploy concluÃ­do: $$SERVICE_NAME"
    waitFor: ["push-tag", "push-latest", "push-env"]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 6) Smoke test â€” Health check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: "smoke-test-health"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        set -euo pipefail

        SERVICE_NAME="${_SERVICE}-${_ENV}"

        # Obter URL do serviÃ§o
        SERVICE_URL=$$(gcloud run services describe "$$SERVICE_NAME" \
          --region "${_REGION}" \
          --format "value(status.url)")

        echo "ğŸ¥ Verificando health em $$SERVICE_URL/health..."

        # Aguardar serviÃ§o estabilizar
        sleep 10

        # Health check com retry
        for i in 1 2 3 4 5; do
          RESPONSE=$$(curl -s -o /dev/null -w "%{http_code}" "$$SERVICE_URL/health" || true)
          if [ "$$RESPONSE" = "200" ]; then
            echo "âœ… Health check passou (tentativa $$i)"
            exit 0
          fi
          echo "â³ Tentativa $$i: HTTP $$RESPONSE, aguardando..."
          sleep 5
        done

        echo "âŒ Health check falhou apÃ³s 5 tentativas"
        exit 1
    waitFor: ["deploy-cloud-run"]
    